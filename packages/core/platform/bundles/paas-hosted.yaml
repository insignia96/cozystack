{{- $cozyConfig := lookup "v1" "ConfigMap" "cozy-system" "cozystack" }}
{{- $clusterDomain := (index $cozyConfig.data "cluster-domain") | default "cozy.local" }}
{{- $oidcEnabled := index $cozyConfig.data "oidc-enabled" }}
{{- $host := index $cozyConfig.data "root-host" }}
{{- if not $host }}
{{- fail "ERROR need root-host in cozystack ConfigMap" }}
{{- end }}
{{- $apiServerEndpoint := index $cozyConfig.data "api-server-endpoint" }}
{{- if not $apiServerEndpoint }}
{{- fail "ERROR need api-server-endpoint in cozystack ConfigMap" }}
{{- end }}

releases:
- name: cert-manager-crds
  releaseName: cert-manager-crds
  chart: cozy-cert-manager-crds
  namespace: cozy-cert-manager
  dependsOn: []

- name: cozystack-api
  releaseName: cozystack-api
  chart: cozy-cozystack-api
  namespace: cozy-system
  dependsOn: [cozystack-controller]
  values:
    cozystackAPI:
      localK8sAPIEndpoint:
        enabled: false

- name: cozystack-controller
  releaseName: cozystack-controller
  chart: cozy-cozystack-controller
  namespace: cozy-system
  dependsOn: []
  {{- if eq (index $cozyConfig.data "telemetry-enabled") "false" }}
  values:
    cozystackController:
      disableTelemetry: true
  {{- end }}

- name: backup-controller
  releaseName: backup-controller
  chart: cozy-backup-controller
  namespace: cozy-backup-controller

- name: lineage-controller-webhook
  releaseName: lineage-controller-webhook
  chart: cozy-lineage-controller-webhook
  namespace: cozy-system
  dependsOn: [cozystack-controller,cert-manager]

- name: cozystack-resource-definition-crd
  releaseName: cozystack-resource-definition-crd
  chart: cozystack-resource-definition-crd
  namespace: cozy-system
  dependsOn: [cozystack-api,cozystack-controller]

- name: bootbox-rd
  releaseName: bootbox-rd
  chart: bootbox-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: bucket-rd
  releaseName: bucket-rd
  chart: bucket-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: clickhouse-rd
  releaseName: clickhouse-rd
  chart: clickhouse-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: etcd-rd
  releaseName: etcd-rd
  chart: etcd-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: ferretdb-rd
  releaseName: ferretdb-rd
  chart: ferretdb-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: foundationdb-rd
  releaseName: foundationdb-rd
  chart: foundationdb-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: http-cache-rd
  releaseName: http-cache-rd
  chart: http-cache-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: info-rd
  releaseName: info-rd
  chart: info-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: ingress-rd
  releaseName: ingress-rd
  chart: ingress-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: kafka-rd
  releaseName: kafka-rd
  chart: kafka-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: kubernetes-rd
  releaseName: kubernetes-rd
  chart: kubernetes-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: monitoring-rd
  releaseName: monitoring-rd
  chart: monitoring-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: mysql-rd
  releaseName: mysql-rd
  chart: mysql-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: nats-rd
  releaseName: nats-rd
  chart: nats-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: postgres-rd
  releaseName: postgres-rd
  chart: postgres-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: rabbitmq-rd
  releaseName: rabbitmq-rd
  chart: rabbitmq-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: redis-rd
  releaseName: redis-rd
  chart: redis-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: seaweedfs-rd
  releaseName: seaweedfs-rd
  chart: seaweedfs-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: tcp-balancer-rd
  releaseName: tcp-balancer-rd
  chart: tcp-balancer-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: tenant-rd
  releaseName: tenant-rd
  chart: tenant-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: virtual-machine-rd
  releaseName: virtual-machine-rd
  chart: virtual-machine-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: virtualprivatecloud-rd
  releaseName: virtualprivatecloud-rd
  chart: virtualprivatecloud-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: vm-disk-rd
  releaseName: vm-disk-rd
  chart: vm-disk-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: vm-instance-rd
  releaseName: vm-instance-rd
  chart: vm-instance-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: vpn-rd
  releaseName: vpn-rd
  chart: vpn-rd
  namespace: cozy-system
  dependsOn: [cozystack-resource-definition-crd]

- name: cert-manager
  releaseName: cert-manager
  chart: cozy-cert-manager
  namespace: cozy-cert-manager
  dependsOn: [cert-manager-crds]

- name: cert-manager-issuers
  releaseName: cert-manager-issuers
  chart: cozy-cert-manager-issuers
  namespace: cozy-cert-manager
  dependsOn: [cert-manager]

- name: prometheus-operator-crds
  releaseName: prometheus-operator-crds
  chart: cozy-prometheus-operator-crds
  namespace: cozy-victoria-metrics-operator
  dependsOn: []

- name: metrics-server
  releaseName: metrics-server
  chart: cozy-metrics-server
  namespace: cozy-monitoring
  dependsOn: [prometheus-operator-crds]

- name: victoria-metrics-operator
  releaseName: victoria-metrics-operator
  chart: cozy-victoria-metrics-operator
  namespace: cozy-victoria-metrics-operator
  dependsOn: [cert-manager,prometheus-operator-crds]

- name: monitoring-agents
  releaseName: monitoring-agents
  chart: cozy-monitoring-agents
  namespace: cozy-monitoring
  privileged: true
  dependsOn: [victoria-metrics-operator, vertical-pod-autoscaler-crds, metrics-server]
  values:
    scrapeRules:
      etcd:
        enabled: true

- name: etcd-operator
  releaseName: etcd-operator
  chart: cozy-etcd-operator
  namespace: cozy-etcd-operator
  dependsOn: [cert-manager]

- name: grafana-operator
  releaseName: grafana-operator
  chart: cozy-grafana-operator
  namespace: cozy-grafana-operator
  dependsOn: []

- name: mariadb-operator
  releaseName: mariadb-operator
  chart: cozy-mariadb-operator
  namespace: cozy-mariadb-operator
  dependsOn: [cert-manager,victoria-metrics-operator]
  values:
    mariadb-operator:
      clusterName: {{ $clusterDomain }}

- name: postgres-operator
  releaseName: postgres-operator
  chart: cozy-postgres-operator
  namespace: cozy-postgres-operator
  dependsOn: [cert-manager,victoria-metrics-operator]

- name: kafka-operator
  releaseName: kafka-operator
  chart: cozy-kafka-operator
  namespace: cozy-kafka-operator
  dependsOn: [victoria-metrics-operator]
  values:
    strimzi-kafka-operator:
      kubernetesServiceDnsDomain: {{ $clusterDomain }}

- name: clickhouse-operator
  releaseName: clickhouse-operator
  chart: cozy-clickhouse-operator
  namespace: cozy-clickhouse-operator
  dependsOn: [victoria-metrics-operator]

- name: foundationdb-operator
  releaseName: foundationdb-operator
  chart: cozy-foundationdb-operator
  namespace: cozy-foundationdb-operator
  dependsOn: [cert-manager]

- name: rabbitmq-operator
  releaseName: rabbitmq-operator
  chart: cozy-rabbitmq-operator
  namespace: cozy-rabbitmq-operator
  dependsOn: []

- name: redis-operator
  releaseName: redis-operator
  chart: cozy-redis-operator
  namespace: cozy-redis-operator
  dependsOn: []

- name: piraeus-operator
  releaseName: piraeus-operator
  chart: cozy-piraeus-operator
  namespace: cozy-linstor
  dependsOn: [cert-manager]

- name: objectstorage-controller
  releaseName: objectstorage-controller
  chart: cozy-objectstorage-controller
  namespace: cozy-objectstorage-controller
  dependsOn: []

- name: telepresence
  releaseName: traffic-manager
  chart: cozy-telepresence
  namespace: cozy-telepresence
  optional: true
  dependsOn: []

- name: external-dns
  releaseName: external-dns
  chart: cozy-external-dns
  namespace: cozy-external-dns
  optional: true
  dependsOn: []

- name: external-secrets-operator
  releaseName: external-secrets-operator
  chart: cozy-external-secrets-operator
  namespace: cozy-external-secrets-operator
  optional: true
  dependsOn: []

- name: dashboard
  releaseName: dashboard
  chart: cozy-dashboard
  namespace: cozy-dashboard
  values:
    {{- $dashboardKCconfig := lookup "v1" "ConfigMap" "cozy-dashboard" "kubeapps-auth-config" }}
    {{- $dashboardKCValues := dig "data" "values.yaml" (dict) $dashboardKCconfig }}
    {{- toYaml (deepCopy $dashboardKCValues | mergeOverwrite (fromYaml (include "cozystack.defaultDashboardValues" .))) | nindent 4 }}
  {{- if eq $oidcEnabled "true" }}
  dependsOn: [keycloak-configure,cozystack-api]
  {{- else }}
  dependsOn: []
  {{- end }}

{{- if $oidcEnabled }}
- name: keycloak
  releaseName: keycloak
  chart: cozy-keycloak
  namespace: cozy-keycloak
  dependsOn: [postgres-operator]

- name: keycloak-operator
  releaseName: keycloak-operator
  chart: cozy-keycloak-operator
  namespace: cozy-keycloak
  dependsOn: [keycloak]

- name: keycloak-configure
  releaseName: keycloak-configure
  chart: cozy-keycloak-configure
  namespace: cozy-keycloak
  dependsOn: [keycloak-operator]
  values:
    cozystack:
      configHash: {{ $cozyConfig | toJson | sha256sum }}
{{- end }}

- name: goldpinger
  releaseName: goldpinger
  chart: cozy-goldpinger
  namespace: cozy-goldpinger
  privileged: true
  dependsOn: [monitoring-agents]

- name: vertical-pod-autoscaler
  releaseName: vertical-pod-autoscaler
  chart: cozy-vertical-pod-autoscaler
  namespace: cozy-vertical-pod-autoscaler
  privileged: true
  dependsOn: [monitoring-agents]
  values:
    vertical-pod-autoscaler:
      recommender:
        extraArgs:
          prometheus-address: http://vmselect-shortterm.tenant-root.svc.{{ $clusterDomain }}:8481/select/0/prometheus/

- name: vertical-pod-autoscaler-crds
  releaseName: vertical-pod-autoscaler-crds
  chart: cozy-vertical-pod-autoscaler-crds
  namespace: cozy-vertical-pod-autoscaler
  privileged: true
  dependsOn: []

- name: velero
  releaseName: velero
  chart: cozy-velero
  namespace: cozy-velero
  privileged: true
  optional: true
  dependsOn: [monitoring-agents]

- name: hetzner-robotlb
  releaseName: robotlb
  optional: true
  chart: cozy-hetzner-robotlb
  namespace: cozy-hetzner-robotlb
